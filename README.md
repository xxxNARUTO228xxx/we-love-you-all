# Веб-сервис для поиска вооруженных людей FindGun.

Проект для определения вооруженных людей на видеозаписи, либо на `rtsp`-потоке с камер городского наблюдения.

Данный сервис использует систему компьютерного зрения на основе нейронных сетей.

Система компьютерного зрения:

* детектирует людей (класс `person`)
* детектирует оружие (класс `weapon`)
* определяет `позу прицеливающегося стрелка`

Пример, результата работы сервиса приведен ниже.

![Index Image](/repo_pics/shooter_detection.jpg)

Проект разработан командой `BaseLine Solution`, участвующей в хакатоне от `Лидеры цифровой трансформации` ([ссылка](https://i.moscow/lct/krasnodar?utm_source=socseti_aim&utm_medium=aim&utm_campaign=smm#faq)).

# Web-приложение

## Frontend часть веб-приложения

### Страница веб-приложения FindGun для загрузи архива с видео

![Index Image](/app/readme_image/index.png)


1 - Header с ссылками для навигации по сервису;  
2 - File input для загрузки zip архива с видео;  
3 - Кнопка отправки архива с видео на обработку веб сервисом;  
4 - Прогресс бар, который показывает этап обработки видео;  
5 - Поле заполняемое карточками с результатами работы модели. Каждая карточка имеет имя кадра в формате unix timestamp, названия классов. Каждое изображение можно открыть в диалоговом окне, если нажать на него;  
6 - Кнопка для скачивания фотографии и разметки в формате `yolo` в виде `*.txt`-файла.

В веб-сервисе п.6 реализована возможность скачать исходный кадр и разметку в формате `yolo` в виде `*.txt`-файла:

```
<target> <x-center> <y-center> <width> <height>
```

Оператор системы после визуальной оценки ее работы, может сохранить разметку кадра, импортировать ее в развернутый локально сервер с сервисом разметки (например, `CVAT`([ссылка](https://www.cvat.ai/))) и поправить разметку.

Накопив таких данных их можно скачать в виде обучающего набора данных (`Dataset'a`) и дообучить модель.


### Страница веб-приложения FindGun для обработки rtsp-потоков

![Rtsp Image](/app/readme_image/rtsp.png?raw=true)

1 - Text input для ссылок на rtsp поток;  
2 - Кнопка отправки ссылки на обработку веб сервисом;  
3 - Кнопка остановки чтения потока;  
4 - Поле для вывода rtsp потока;  
5 - Поле заполняемое катрточками с результатами работы модели.

### Docker для сборки веб-приложения

Вначале перейдем в каталог `./app`, выполнив команду:
```bash
cd app
```

Для сборки образа необходимо использовать:
```
docker build -t findgun .
```  
Веб-сервис развернутый в `Docker` будет использовать для инференса `CPU`.

Для запуска контейнера, выполним команду:
```
docker run -p 3000:3000 findgun:latest
```  

# Backend часть веб-приложения

Написан на [FastAPI](https://fastapi.tiangolo.com).


## Установка зависимостей

Вначале перейдем в каталог `./app/web/backend`, выполнив команду:
```bash
cd app/web/backend
```

Далее развернем виртуальное окружение в `pipenv`, выполнив команды:

```bash
pipenv shell

#Для инферентса на CPU:
pipenv install

#Для инференса на GPU, если стоит CUDA 11.7:
pip install -r requirements.txt

#Если версия CUDA отлична от 11.7, то необходимо изменить зависимости в requirements.txt:
https://pytorch.org/get-started/previous-versions/
```

## Модель

Модели доступны по ссылке:

```
https://disk.yandex.ru/d/IXNEekqbN7P01Q
```

Модель для детекции `person` и `weapon`
необходимо переместить в `backend/yolo/` с названием `yolovX`

Чтобы добавить классификатор его необходимо поместить в `backend/yolo/`
c названием `yolovCLS`

## Запуск

Запустим `Backend` часть веб-приложения, выполнив команду:

Linux:
```bash
sh ./scripts/run.sh
```
  

Windows:  
```bash
./scripts/run.bat
```


